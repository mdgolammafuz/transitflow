name: Production Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # STAGE 1: Continuous Integration (CI)
  # Runs on GitHub's servers. Blocks deployment if tests fail.
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Install the project in editable mode
          pip install -e .

      - name: Run Test Suite
        # We use the existing make target as requested.
        # This assumes 'make test-all' runs pytest on tests/ and its subfolders.
        run: make test-all

  # STAGE 2: Continuous Deployment (CD)
  # Runs on your Google Cloud VM via SSH.
  deploy:
    needs: quality-check
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Google Cloud VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 300s
          script: |
            # Stop execution immediately if any command fails
            set -e

            echo "Starting Deployment..."

            # 1. Navigate to Project Directory
            cd /home/golammafuzgm/transitflow

            # 2. Pull Latest Changes
            git fetch origin main
            git reset --hard origin/main

            # 3. Restart Services
            # We assume 'make dev-up' handles docker-compose build and up
            make dev-down
            make dev-up

            # 4. Post-Deployment Verification
            echo "Waiting 20 seconds for containers to stabilize..."
            sleep 20

            # 5. Run Smoke Test
            # This executes the verification script inside the running API container.
            # We use -T to avoid the 'input device is not a TTY' error.
            # NEW (Matches your docker-compose.yml)
            if docker ps | grep -q "serving-api"; then
                # We execute the test inside the 'serving-api' container
                docker exec -T serving-api python scripts/verify_ml_serving.py
            else
                echo "WARNING: Container 'serving-api' not found. Checking generic docker ps..."
                docker ps
                exit 1 # Fail the deploy if the API is missing
            fi
            echo "Deployment Complete."