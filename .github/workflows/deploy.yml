name: Production Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # STAGE 1: Continuous Integration (CI)
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Installs dependencies + dev tools (pytest) from pyproject.toml
          pip install -e ".[dev]"

      - name: Load Configuration
        # Retrieves the secret you created and writes it to the file path expected by conftest.py
        env:
          CI_ENV_CONTENT: ${{ secrets.CI_ENV_FILE }}
        run: |
          mkdir -p infra/local
          echo "$CI_ENV_CONTENT" > infra/local/.env

      - name: Run Test Suite
        run: make test-all

  # STAGE 2: Continuous Deployment (CD)
  deploy:
    needs: quality-check
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Google Cloud VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 300s
          script: |
            set -e

            echo "Starting Deployment..."

            cd /home/golammafuzgm/transitflow

            # 1. Pull Latest Changes
            git fetch origin main
            git reset --hard origin/main

            # 2. Restart Services
            make dev-down
            make dev-up

            echo "Waiting 20 seconds for containers to stabilize..."
            sleep 20

            # 3. Smoke Test
            if docker ps | grep -q "serving-api"; then
                docker exec -T serving-api python scripts/verify_ml_serving.py
            else
                echo "WARNING: Container 'serving-api' not found. Checking generic docker ps..."
                docker ps
                exit 1
            fi
            
            echo "Deployment Complete."