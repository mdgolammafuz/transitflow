# TransitFlow Nginx Reverse Proxy

server {
    listen 80;
    server_name _;

    # 1. Dashboard UI (The Single Page App)
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 2. Serving API (Main Logic)
    # The trailing slash at the end of proxy_pass is CRITICAL.
    # It tells Nginx to strip '/api/' before sending the request to the container.
    location /api/ {
        proxy_pass http://serving-api:8001/;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts for slower ML predictions
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
    }

    # 3. API Documentation
    location /docs {
        proxy_pass http://serving-api:8001/docs;
        proxy_set_header Host $host;
    }

    location /openapi.json {
        proxy_pass http://serving-api:8001/openapi.json;
    }

    # 4. Grafana (Observability)
    location /grafana/ {
        proxy_pass http://grafana:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 5. Prometheus (Metrics)
    location /prometheus/ {
        proxy_pass http://prometheus:9090/;
        proxy_set_header Host $host;
    }

    # 6. Feature API (Direct Access to Raw Data)
    location /features/ {
        proxy_pass http://feature-api:8000/;  # Matches container_name:port
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Health check override
    location /health {
        proxy_pass http://serving-api:8001/health;
        proxy_set_header Host $host;
    }
}