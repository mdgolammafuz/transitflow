version: 2

models:
  - name: fct_stop_arrivals
    description: "Final Feature Store table for API serving - Event-level Stop Performance"
    config:
      contract:
        enforced: true
    columns:
      - name: feature_id
        data_type: text
        data_tests:
          - unique
          - not_null
      - name: stop_id
        data_type: text
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_stops')
              field: stop_id
              config:
                severity: warn
      - name: line_id
        data_type: text
      - name: event_date
        data_type: date
        data_tests:
          - not_null
      - name: hour_of_day
        data_type: integer
      - name: day_of_week
        data_type: integer
      - name: delay_category
        data_type: text
        data_tests:
          - not_null
          - accepted_values:
              values: ['ON_TIME', 'LATE', 'VERY_LATE']
      - name: historical_arrival_count
        data_type: bigint
      - name: historical_avg_delay
        data_type: double precision
      - name: historical_stddev_delay
        data_type: double precision
      - name: historical_on_time_pct
        data_type: double precision
      - name: avg_dwell_time_ms
        data_type: double precision
      - name: stop_name
        data_type: text
      - name: zone_id
        data_type: text
      - name: stop_lat
        data_type: double precision
      - name: stop_lon
        data_type: double precision
      - name: stop_code
        data_type: text
      - name: line_name
        data_type: text
      - name: line_type
        data_type: text
      - name: processing_time
        data_type: timestamp
      - name: ingestion_time
        data_type: timestamp
      # METADATA ADDITIONS FOR UNIQUENESS
      - name: kafka_partition
        data_type: integer
      - name: kafka_offset
        data_type: bigint
    data_tests:
      # Guaranteed unique via Kafka markers.
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [kafka_partition, kafka_offset, stop_id]

  - name: fct_daily_performance
    description: "Daily aggregated performance metrics by line."
    config:
      contract:
        enforced: true
    columns:
      - name: metric_id
        data_type: text
        data_tests:
          - unique
          - not_null
      - name: line_id
        data_type: text
        data_tests:
          - not_null
      - name: metric_date
        data_type: date
      - name: total_journeys
        data_type: bigint
      - name: total_events
        data_type: bigint
        data_tests:
          - not_null
      - name: unique_vehicles
        data_type: bigint
      - name: avg_delay_seconds
        data_type: double precision
      - name: on_time_percentage
        data_type: double precision
      - name: total_distance_km
        data_type: double precision